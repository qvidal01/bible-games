name: Deploy to Production

# NOTE: Deployment to private network requires self-hosted runner or SSH tunnel
# Currently only builds and tests. Manual deployment via SSH from local machine.

on:
  # Disabled: push triggers - uncomment when self-hosted runner is set up
  # push:
  #   branches: [main]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'update'
        type: choice
        options:
          - update
          - full

env:
  CONTAINER_ID: 350
  APP_USER: appuser
  APP_DIR: /home/appuser/projects/bible-games

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --workspace @bible-games/web || true

      - name: Build
        run: npm run build --workspace @bible-games/web
        env:
          NEXT_PUBLIC_PUSHER_KEY: ${{ secrets.NEXT_PUBLIC_PUSHER_KEY }}
          NEXT_PUBLIC_PUSHER_CLUSTER: us2

      - name: Run tests
        run: npm test --workspace @bible-games/web || true

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROXMOX_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Determine deployment type
            DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'update' }}"

            # Execute deployment in container
            if [ "$DEPLOY_TYPE" = "full" ]; then
              sudo pct exec 350 -- su - appuser -c '/home/appuser/projects/bible-games/deploy/deploy.sh'
            else
              sudo pct exec 350 -- su - appuser -c '/home/appuser/projects/bible-games/deploy/update.sh'
            fi

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROXMOX_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Check PM2 status
            sudo pct exec 350 -- su - appuser -c 'pm2 show bible-games | grep status'

            # Health check
            sleep 3
            curl -sf http://192.168.0.52:3000 > /dev/null && echo "Health check passed!" || echo "Health check failed!"

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed! Check the logs above."

  notify:
    name: Deployment Notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "üåê Live at: https://games.aiqso.io"
          else
            echo "‚ùå Deployment failed!"
          fi
